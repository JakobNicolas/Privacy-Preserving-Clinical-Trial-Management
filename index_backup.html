<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Drug Trial Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .connection-status {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }

        .connection-status.connected {
            background: #28a745;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .status-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .phase-indicator {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            font-weight: bold;
            margin: 10px 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.danger {
            background: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .countdown {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Confidential Drug Trial Platform</h1>
            <p>Privacy-Preserving Clinical Research Using Fully Homomorphic Encryption</p>
            <div id="connectionStatus" class="connection-status">
                Wallet Not Connected
            </div>
        </div>

        <div class="section">
            <h2>üìä Trial Status</h2>
            <div class="status-grid">
                <div class="status-card">
                    <h3>Current Phase</h3>
                    <div class="phase-indicator" id="currentPhase">Loading...</div>
                </div>
                <div class="status-card">
                    <h3>Participants</h3>
                    <div class="status-value" id="participantCount">0</div>
                </div>
                <div class="status-card">
                    <h3>Time Until Next Phase</h3>
                    <div class="countdown" id="phaseCountdown">--:--:--</div>
                </div>
                <div class="status-card">
                    <h3>Your Status</h3>
                    <div class="status-value" id="userStatus">Not Enrolled</div>
                </div>
            </div>
            <button class="button" id="connectWallet">üîó Connect Wallet</button>
            <button class="button secondary" id="refreshStatus">üîÑ Refresh Status</button>
            <button class="button" id="transitionPhase">‚è≠Ô∏è Transition Phase</button>
        </div>

        <div id="enrollmentSection" class="section">
            <h2>üìù Patient Enrollment</h2>
            <div id="enrollmentAlert" class="alert info">
                Complete the form below to enroll in the confidential drug trial. Your data will be encrypted and kept private.
            </div>
            <div class="form-grid">
                <div class="input-group">
                    <label for="patientAge">Age (18-80)</label>
                    <input type="number" id="patientAge" min="18" max="80" placeholder="Enter your age">
                </div>
                <div class="input-group">
                    <label for="healthScore">Health Score (0-100)</label>
                    <input type="number" id="healthScore" min="0" max="100" placeholder="Overall health rating">
                </div>
                <div class="input-group">
                    <label for="vitalSigns">Vital Signs (Encoded)</label>
                    <input type="number" id="vitalSigns" min="0" max="65535" placeholder="Heart rate & BP encoded">
                </div>
            </div>
            <button class="button" id="enrollButton">‚úÖ Enroll in Trial</button>
        </div>

        <div id="clinicalDataSection" class="section hidden">
            <h2>ü©∫ Clinical Data Submission</h2>
            <div id="clinicalAlert" class="alert info">
                Submit your weekly clinical measurements. All data is encrypted for privacy.
            </div>
            <div class="form-grid">
                <div class="input-group">
                    <label for="effectivenessScore">Effectiveness Score (0-100)</label>
                    <input type="number" id="effectivenessScore" min="0" max="100" placeholder="Treatment effectiveness">
                </div>
                <div class="input-group">
                    <label for="sideEffectLevel">Side Effect Level (0-10)</label>
                    <input type="number" id="sideEffectLevel" min="0" max="10" placeholder="Side effect severity">
                </div>
                <div class="input-group">
                    <label for="biomarkers">Biomarkers (Encoded)</label>
                    <input type="number" id="biomarkers" min="0" max="65535" placeholder="Lab results encoded">
                </div>
                <div class="input-group">
                    <label for="weekNumber">Week Number (1-12)</label>
                    <select id="weekNumber">
                        <option value="">Select week...</option>
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                        <option value="5">Week 5</option>
                        <option value="6">Week 6</option>
                        <option value="7">Week 7</option>
                        <option value="8">Week 8</option>
                        <option value="9">Week 9</option>
                        <option value="10">Week 10</option>
                        <option value="11">Week 11</option>
                        <option value="12">Week 12</option>
                    </select>
                </div>
            </div>
            <button class="button" id="submitDataButton">üì§ Submit Clinical Data</button>
        </div>

        <div id="resultsSection" class="section">
            <h2>üìà Trial Results</h2>
            <div id="resultsAlert" class="alert info">
                View aggregated trial results while maintaining individual privacy.
            </div>
            <div class="status-grid">
                <div class="status-card">
                    <h3>Trial Completed</h3>
                    <div class="status-value" id="trialCompleted">No</div>
                </div>
                <div class="status-card">
                    <h3>Results Available</h3>
                    <div class="status-value" id="resultsCalculated">No</div>
                </div>
                <div class="status-card">
                    <h3>Total Participants</h3>
                    <div class="status-value" id="totalParticipants">0</div>
                </div>
                <div class="status-card">
                    <h3>Completion Time</h3>
                    <div class="status-value" id="completionTime">-</div>
                </div>
            </div>
            <button class="button" id="getResultsButton">üìä Get Trial Results</button>
            <button class="button danger" id="emergencyTermination">üö® Emergency Termination</button>
        </div>

        <div id="measurementsHistory" class="section">
            <h2>üìã Your Measurements History</h2>
            <div class="status-card">
                <h3>Measurements Submitted</h3>
                <div class="status-value" id="measurementCount">0</div>
            </div>
            <button class="button secondary" id="refreshMeasurements">üîÑ Refresh Count</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0x6BCaFCD0C3AfbD07F54438BE937135D9b5B534a6";
        const CONTRACT_ABI = [
            "function enrollPatient(uint8 _age, uint8 _healthScore, uint16 _vitalSigns) external",
            "function submitClinicalData(uint8 _effectivenessScore, uint8 _sideEffectLevel, uint16 _biomarkers, uint8 _week) external",
            "function transitionToNextPhase() external",
            "function getTrialStatus() external view returns (uint8 phase, uint256 participantCount, uint256 timeUntilNextPhase, bool canTransition)",
            "function getPatientStatus(address patient) external view returns (bool enrolled, bool consentGiven, uint256 enrollmentTime)",
            "function getTrialResults(uint8 phase) external view returns (bool completed, bool resultsCalculated, uint256 completionTime, uint8 participantCount)",
            "function getCurrentPhaseName() external view returns (string memory)",
            "function getPatientMeasurementCount(address patient) external view returns (uint8 count)",
            "function emergencyTermination() external",
            "function canTransitionPhase() external view returns (bool)",
            "event PatientEnrolled(address indexed patient, uint256 timestamp)",
            "event ClinicalDataSubmitted(address indexed patient, uint8 week)",
            "event PhaseTransition(uint8 indexed fromPhase, uint8 indexed toPhase, uint256 timestamp)",
            "event TrialCompleted(uint8 indexed phase, uint256 timestamp)",
            "event ResultsPublished(uint8 indexed phase, bool significantDifference)"
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;

        // Initialize the application
        async function init() {
            console.log('Initializing application...');
            try {
                setupEventListeners();
                await checkConnection();
                await updateTrialStatus();
                startCountdown();
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Initialization failed:', error);
                showAlert('error', 'Failed to load application. Please refresh the page.');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('refreshStatus').addEventListener('click', updateTrialStatus);
            document.getElementById('enrollButton').addEventListener('click', enrollPatient);
            document.getElementById('submitDataButton').addEventListener('click', submitClinicalData);
            document.getElementById('transitionPhase').addEventListener('click', transitionPhase);
            document.getElementById('getResultsButton').addEventListener('click', getTrialResults);
            document.getElementById('emergencyTermination').addEventListener('click', emergencyTermination);
            document.getElementById('refreshMeasurements').addEventListener('click', refreshMeasurements);
        }

        // Check if wallet is already connected
        async function checkConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Error checking connection:', error);
                }
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showAlert('error', 'MetaMask is not installed. Please install MetaMask to continue.');
                    return;
                }

                if (typeof ethers === 'undefined') {
                    showAlert('error', 'Ethers.js library is not loaded. Please refresh the page.');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('connectionStatus').textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectionStatus').className = 'connection-status connected';

                await updateUserStatus();
                await updateTrialStatus();
                showAlert('success', 'Wallet connected successfully!');
            } catch (error) {
                showAlert('error', `Failed to connect wallet: ${error.message}`);
            }
        }

        // Update trial status
        async function updateTrialStatus() {
            if (!contract) {
                document.getElementById('currentPhase').textContent = 'Connect Wallet';
                return;
            }

            try {
                const status = await contract.getTrialStatus();
                const phaseName = await contract.getCurrentPhaseName();

                document.getElementById('currentPhase').textContent = phaseName;
                document.getElementById('participantCount').textContent = status.participantCount.toString();

                const timeLeft = status.timeUntilNextPhase.toNumber();
                updateCountdown(timeLeft);

                const phase = status.phase;
                updateSectionVisibility(phase);

            } catch (error) {
                console.error('Error updating trial status:', error);
                document.getElementById('currentPhase').textContent = 'Error Loading';
            }
        }

        // Update user-specific status
        async function updateUserStatus() {
            if (!contract || !userAddress) return;

            try {
                const patientStatus = await contract.getPatientStatus(userAddress);

                if (patientStatus.enrolled) {
                    document.getElementById('userStatus').textContent = 'Enrolled';
                    document.getElementById('enrollmentSection').classList.add('hidden');
                    document.getElementById('clinicalDataSection').classList.remove('hidden');
                } else {
                    document.getElementById('userStatus').textContent = 'Not Enrolled';
                    document.getElementById('enrollmentSection').classList.remove('hidden');
                    document.getElementById('clinicalDataSection').classList.add('hidden');
                }

                await refreshMeasurements();
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        // Update section visibility based on phase
        function updateSectionVisibility(phase) {
            const enrollmentSection = document.getElementById('enrollmentSection');
            const clinicalDataSection = document.getElementById('clinicalDataSection');

            if (phase === 1) {
                enrollmentSection.classList.remove('hidden');
            } else {
                enrollmentSection.classList.add('hidden');
            }

            if (phase === 2) {
                clinicalDataSection.classList.remove('hidden');
            }
        }

        // Start countdown timer
        function startCountdown() {
            setInterval(updateTrialStatus, 60000);
        }

        // Update countdown display
        function updateCountdown(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            document.getElementById('phaseCountdown').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Enroll patient
        async function enrollPatient() {
            if (!contract) {
                showAlert('error', 'Please connect your wallet first');
                return;
            }

            const age = document.getElementById('patientAge').value;
            const healthScore = document.getElementById('healthScore').value;
            const vitalSigns = document.getElementById('vitalSigns').value;

            if (!age || !healthScore || !vitalSigns) {
                showAlert('error', 'Please fill in all fields');
                return;
            }

            if (age < 18 || age > 80) {
                showAlert('error', 'Age must be between 18 and 80');
                return;
            }

            if (healthScore < 0 || healthScore > 100) {
                showAlert('error', 'Health score must be between 0 and 100');
                return;
            }

            try {
                showAlert('info', 'Enrolling patient... Please confirm the transaction.');
                const tx = await contract.enrollPatient(age, healthScore, vitalSigns);
                showAlert('info', 'Transaction submitted. Waiting for confirmation...');
                await tx.wait();
                showAlert('success', 'Successfully enrolled in the trial!');
                await updateUserStatus();
                await updateTrialStatus();
            } catch (error) {
                showAlert('error', `Enrollment failed: ${error.message}`);
            }
        }

        // Submit clinical data
        async function submitClinicalData() {
            if (!contract) {
                showAlert('error', 'Please connect your wallet first');
                return;
            }

            const effectivenessScore = document.getElementById('effectivenessScore').value;
            const sideEffectLevel = document.getElementById('sideEffectLevel').value;
            const biomarkers = document.getElementById('biomarkers').value;
            const weekNumber = document.getElementById('weekNumber').value;

            if (!effectivenessScore || !sideEffectLevel || !biomarkers || !weekNumber) {
                showAlert('error', 'Please fill in all fields');
                return;
            }

            try {
                showAlert('info', 'Submitting clinical data... Please confirm the transaction.');
                const tx = await contract.submitClinicalData(effectivenessScore, sideEffectLevel, biomarkers, weekNumber);
                showAlert('info', 'Transaction submitted. Waiting for confirmation...');
                await tx.wait();
                showAlert('success', 'Clinical data submitted successfully!');
                await refreshMeasurements();

                document.getElementById('effectivenessScore').value = '';
                document.getElementById('sideEffectLevel').value = '';
                document.getElementById('biomarkers').value = '';
                document.getElementById('weekNumber').value = '';
            } catch (error) {
                showAlert('error', `Data submission failed: ${error.message}`);
            }
        }

        // Transition to next phase
        async function transitionPhase() {
            if (!contract) {
                showAlert('error', 'Please connect your wallet first');
                return;
            }

            try {
                const canTransition = await contract.canTransitionPhase();
                if (!canTransition) {
                    showAlert('error', 'Cannot transition phase yet. Please wait for the phase duration to complete.');
                    return;
                }

                showAlert('info', 'Transitioning to next phase... Please confirm the transaction.');
                const tx = await contract.transitionToNextPhase();
                showAlert('info', 'Transaction submitted. Waiting for confirmation...');
                await tx.wait();
                showAlert('success', 'Successfully transitioned to next phase!');
                await updateTrialStatus();
            } catch (error) {
                showAlert('error', `Phase transition failed: ${error.message}`);
            }
        }

        // Get trial results
        async function getTrialResults() {
            if (!contract) {
                showAlert('error', 'Please connect your wallet first');
                return;
            }

            try {
                const results = await contract.getTrialResults(4);

                document.getElementById('trialCompleted').textContent = results.completed ? 'Yes' : 'No';
                document.getElementById('resultsCalculated').textContent = results.resultsCalculated ? 'Yes' : 'No';
                document.getElementById('totalParticipants').textContent = results.participantCount.toString();

                if (results.completionTime.toNumber() > 0) {
                    const date = new Date(results.completionTime.toNumber() * 1000);
                    document.getElementById('completionTime').textContent = date.toLocaleString();
                } else {
                    document.getElementById('completionTime').textContent = '-';
                }

                showAlert('success', 'Trial results updated!');
            } catch (error) {
                showAlert('error', `Failed to get trial results: ${error.message}`);
            }
        }

        // Emergency termination
        async function emergencyTermination() {
            if (!contract) {
                showAlert('error', 'Please connect your wallet first');
                return;
            }

            if (!confirm('Are you sure you want to perform an emergency termination? This action cannot be undone.')) {
                return;
            }

            try {
                showAlert('info', 'Performing emergency termination... Please confirm the transaction.');
                const tx = await contract.emergencyTermination();
                showAlert('info', 'Transaction submitted. Waiting for confirmation...');
                await tx.wait();
                showAlert('success', 'Emergency termination completed!');
                await updateTrialStatus();
                await getTrialResults();
            } catch (error) {
                showAlert('error', `Emergency termination failed: ${error.message}`);
            }
        }

        // Refresh measurements count
        async function refreshMeasurements() {
            if (!contract || !userAddress) return;

            try {
                const count = await contract.getPatientMeasurementCount(userAddress);
                document.getElementById('measurementCount').textContent = count.toString();
            } catch (error) {
                console.error('Error refreshing measurements:', error);
            }
        }

        // Show alert messages
        function showAlert(type, message) {
            const existingAlerts = document.querySelectorAll('.alert.temporary');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert ${type} temporary`;
            alert.textContent = message;

            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Handle account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    document.getElementById('connectionStatus').textContent = 'Wallet Not Connected';
                    document.getElementById('connectionStatus').className = 'connection-status';
                    userAddress = null;
                    contract = null;
                    signer = null;
                    provider = null;
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>